<!DOCTYPE html>
<html lang="en">
<head>
    <style>
      .modal-bg {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.4);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-bg.active { display: flex; }
      .modal-form {
        background: #fbf9f2;
        border-radius: 16px;
        padding: 2em 2em 1.5em 2em;
        box-shadow: 0 4px 24px rgba(120,92,82,0.18);
        min-width: 320px;
        max-width: 95vw;
      }
      .modal-form label { display:block; margin-top:1em; font-weight:bold; }
      .modal-form input, .modal-form textarea {
        width: 100%;
        margin-top: 0.3em;
        margin-bottom: 0.7em;
        padding: 0.5em;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1em;
        font-family: inherit;
      }
      .modal-form button { margin-top: 1em; }
      .modal-close { float:right; font-size:1.2em; cursor:pointer; color:#785c52; }
    </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | Parakeet Press</title>
  <link rel="stylesheet" href="style.css">
  <style>
        .video-responsive {
          position: relative;
          width: 100%;
          padding-bottom: 56.25%; /* 16:9 aspect ratio */
          height: 0;
          margin: 1.5em 0;
        }
        .video-responsive iframe {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border: 0;
        }
    .product-detail-full {
      width: 100%;
      max-width: 900px;
      margin: 2em auto;
      background: rgba(251, 249, 242, 0.95);
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(120, 92, 82, 0.10);
      border: 1.5px solid #785c52;
      padding: 2.5em 2em;
      display: block;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
      .product-detail-full {
        padding: 1.2em 0.5em;
      }
    }
    .product-detail-full h2 {
      font-size: 2em;
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <header>
    <img src="pp_files/PP_Logo_Original.png" alt="Parakeet Press Logo" style="height:48px;vertical-align:middle;margin-right:12px;border-radius:12px;">
    <a href="index.html" style="text-decoration:none;color:inherit;"><h1 style="display:inline;vertical-align:middle;">PARAKEET PRESS</h1></a>
    <div style="margin-bottom:8px;"></div>
    <nav>
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="store.html">Store</a>
      <a href="chirp.html">Chirp!</a>
    </nav>
  </header>
  <main>
    <section id="product-detail" style="margin-top:2em;">
      <h2>Product Details</h2>
      <div id="product-detail-card"></div>
    </section>
  </main>
  <footer>
    <p id="copyright"></p>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var year = new Date().getFullYear();
        var copyright = document.getElementById('copyright');
        if (copyright) {
          copyright.innerHTML = `&copy; ${year} Parakeet Press. All rights reserved.`;
        }
      });
    </script>
  </footer>
  <script>
    // Robust CSV parser for quoted fields
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current);
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = (i < values.length && values[i] !== undefined) ? values[i].trim() : '');
        return obj;
      });
    }
    function getTitle() {
      const params = new URLSearchParams(window.location.search);
      return params.get('title');
    }
    function renderProduct(p) {
      let videoEmbed = '';
      if (p.videoLink && p.videoLink.startsWith('http')) {
        let vidId = '';
        if (p.videoLink.includes('youtube.com')) {
          const match = p.videoLink.match(/[?&]v=([^&]+)/);
          vidId = match ? match[1] : '';
        } else if (p.videoLink.includes('youtu.be/')) {
          vidId = p.videoLink.split('youtu.be/')[1];
        }
        if (vidId) {
          videoEmbed = `<div class="video-responsive"><iframe src="https://www.youtube.com/embed/${vidId}" allowfullscreen></iframe></div>`;
        }
      }
      // Fallbacks for blank fields
      function hideIfNA(val) {
        return val && val.trim().toLowerCase() !== 'n/a' ? val.trim() : '';
      }
      const title = hideIfNA(p.title) || 'Untitled';
      const instrumentation = hideIfNA(p.instrumentation);
      const year = hideIfNA(p.year);
      const duration = hideIfNA(p.duration);
      let buyBtn = '';
      const btnText = (p.buyMethod && p.buyMethod.trim()) ? p.buyMethod : 'Buy Score';
      // Always show Contact Daniel button
      buyBtn = `<button class="buy-btn secondary-btn" type="button" id="open-email-modal">Contact Daniel</button>`;
      const buyLink = hideIfNA(p.buyLink);
      const multiplePartsRaw = p.multipleParts ? p.multipleParts.trim() : '';
      const isMultipleParts = multiplePartsRaw && multiplePartsRaw.toLowerCase() !== 'false' && multiplePartsRaw.toLowerCase() !== 'n/a';
      let multiPartsBlock = '';
      if (isMultipleParts) {
        multiPartsBlock += `<div style="margin-bottom:0.5em;font-weight:bold;">Purchase from ${btnText}:</div>`;
        const parts = multiplePartsRaw.split(',').map(s => s.trim()).filter(Boolean);
        const links = buyLink ? buyLink.split(',').map(s => s.trim()) : [];
        multiPartsBlock += '<div style="margin-bottom:1em;">';
        parts.forEach((part, idx) => {
          const partKey = part.replace(/\s+/g, '').toLowerCase();
          let foundLink = '';
          for (const link of links) {
            if (link.replace(/\s+/g, '').toLowerCase().includes(partKey)) {
              foundLink = link;
              break;
            }
          }
          if (foundLink) {
            multiPartsBlock += `<span style="white-space:nowrap;display:inline-block;margin-right:1.2em;">` +
              `<a href="${foundLink}" target="_blank" style="color:#785c52;text-decoration:underline;">${part}</a></span>`;
          } else {
            multiPartsBlock += `<span style="color:#aaa;white-space:nowrap;display:inline-block;margin-right:1.2em;">${part}</span>`;
          }
        });
        multiPartsBlock += '</div>';
      } else if (buyLink) {
        buyBtn += ` <a class="buy-btn" href="${buyLink}" target="_blank">${btnText}</a>`;
      }
      let price = '';
      if (p.price && hideIfNA(p.price)) {
        // Try to extract a number from the price string
        const priceNum = parseFloat(p.price.replace(/[^\d.]/g, ''));
        if (!isNaN(priceNum)) {
          price = `$${priceNum.toFixed(2)}`;
        } else {
          price = p.price.trim();
        }
      }
      const priceNotes = p.priceNotes && hideIfNA(p.priceNotes) ? `<div style='margin:0.2em 0 0.7em 0;font-style:italic;color:#555;'>${p.priceNotes}</div>` : '';
      return `
        <div class="product-detail-full">
          <h2 style="margin-top:0;">${title}</h2>
          ${instrumentation ? `<p><strong>Instrumentation:</strong> ${instrumentation}</p>` : ''}
          ${duration ? `<p><strong>Duration:</strong> ${duration} min</p>` : ''}
          ${year ? `<p><strong>Year:</strong> ${year}</p>` : ''}
          ${price ? `<div style="margin:1.2em 0 0.2em 0;font-weight:bold;">Price: <span style='font-weight:normal;'>${price}</span></div>` : ''}
          ${priceNotes}
          <div style="margin:0.5em 0 0.5em 0;font-weight:bold;">Purchase Options:</div>
          ${multiPartsBlock}
          ${isMultipleParts ? '<div style="margin:0.5em 0 0.5em 3.5em;font-weight:bold;">or</div>' : ''}
          ${buyBtn}
          <div style="margin-top:0.7em;font-size:0.98em;color:#785c52;background:rgba(251,249,242,0.7);border-radius:8px;padding:0.7em 1em 0.7em 1em;max-width:480px;">
            <span style="font-weight:bold;">Save up to 30% by purchasing directly from Daniel.</span> Vendors take a significant cut, so buying direct saves you from paying extra while also allowing me to receive more of your support.
          </div>
          ${videoEmbed}
        </div>
        <div class="modal-bg" id="email-modal">
          <form class="modal-form" id="email-form" onsubmit="return false;">
            <span class="modal-close" id="close-email-modal">&times;</span>
            <h3>Contact to Buy Score</h3>
            <div style="margin-bottom:0.7em;font-size:0.98em;color:#785c52;"><strong>To:</strong> dankimcomposer@gmail.com</div>
            <label for="yourName">Your Name</label>
            <input type="text" id="yourName" name="yourName" required>
            <label for="yourEmail">Your Email</label>
            <input type="email" id="yourEmail" name="yourEmail" required>
            <label for="yourSubject">Subject</label>
            <input type="text" id="yourSubject" name="yourSubject" value="Score Purchase Inquiry: ${title}" required>
            <label for="yourMsg">Message</label>
            <textarea id="yourMsg" name="yourMsg" rows="4">Hello,\n\nI am interested in purchasing the score for \"${title}\".\n\nThank you!</textarea>
            <button type="submit" class="buy-btn">Send Email</button>
          </form>
        </div>
      `;
        // Email modal logic
        document.addEventListener('click', function(e) {
          if (e.target && e.target.id === 'open-email-modal') {
            document.getElementById('email-modal').classList.add('active');
          }
          if (e.target && e.target.id === 'close-email-modal') {
            document.getElementById('email-modal').classList.remove('active');
          }
        });
        document.addEventListener('submit', function(e) {
          if (e.target && e.target.id === 'email-form') {
            const name = document.getElementById('yourName').value;
            const email = document.getElementById('yourEmail').value;
            let msg = document.getElementById('yourMsg').value;
            const subject = encodeURIComponent(`Score Purchase Inquiry: ${document.querySelector('.product-detail-full h2').textContent}`);
            msg = `Name: ${name}\nEmail: ${email}\n\n${msg}`;
            const body = encodeURIComponent(msg);
            // Always send to dankimcomposer@gmail.com
            const emailAddr = 'dankimcomposer@gmail.com';
            window.location.href = `mailto:${emailAddr}?subject=${subject}&body=${body}`;
            document.getElementById('email-modal').classList.remove('active');
          }
        });
    }
    const card = document.getElementById('product-detail-card');
    function showError(msg) {

      card.innerHTML = `<div class="not-available">${msg}</div>`;
    }
    fetch('pp_files/pp_store/scoresShop.csv')
      .then(res => {
        if (!res.ok) {
          showError('Error loading product data.');
          throw new Error('Network error');
        }
        return res.text();
      })
      .then(text => {
        let products;
        try {
          products = parseCSV(text);
        } catch (e) {
          showError('Error parsing product data.');
          throw e;
        }
        const rawTitle = getTitle();
        if (!rawTitle) {
          showError('No product specified.');
          return;
        }
        const decodedTitle = decodeURIComponent(rawTitle).replace(/\+/g, ' ').trim().toLowerCase();
        const p = products.find(prod => (prod.title || '').trim().toLowerCase() === decodedTitle);
        if (!p) {
          showError('Product not found.');
          return;
        }
        try {
          card.innerHTML = renderProduct(p);
          // Attach modal event listeners after rendering
          setTimeout(() => {
            const openBtn = document.getElementById('open-email-modal');
            const closeBtn = document.getElementById('close-email-modal');
            const modal = document.getElementById('email-modal');
            const form = document.getElementById('email-form');
            if (openBtn && modal) {
              openBtn.onclick = () => { modal.classList.add('active'); };
            }
            if (closeBtn && modal) {
              closeBtn.onclick = () => { modal.classList.remove('active'); };
            }
            if (form) {
              form.onsubmit = function() {
                const name = document.getElementById('yourName').value;
                const email = document.getElementById('yourEmail').value;
                const subjectRaw = document.getElementById('yourSubject').value;
                let msg = document.getElementById('yourMsg').value;
                msg = `Name: ${name}\nEmail: ${email}\n\n${msg}`;
                const subject = encodeURIComponent(subjectRaw);
                const body = encodeURIComponent(msg);
                // Always send to dankimcomposer@gmail.com
                const emailAddr = 'dankimcomposer@gmail.com';
                window.location.href = `mailto:${emailAddr}?subject=${subject}&body=${body}`;
                modal.classList.remove('active');
                return false;
              };
            }
          }, 0);
        } catch (e) {
          showError('Error displaying product details.');
        }
      })
      .catch(e => {
        if (!card.innerHTML) showError('Unexpected error loading product.');
      });
  </script>
</body>
</html>
