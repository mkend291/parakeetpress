<!DOCTYPE html>
<html lang="en">
<head>
    <style>
      .modal-bg {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.4);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-bg.active { display: flex; }
      .modal-form {
        background: #fbf9f2;
        border-radius: 16px;
        padding: 2em 2em 1.5em 2em;
        box-shadow: 0 4px 24px rgba(120,92,82,0.18);
        min-width: 320px;
        max-width: 95vw;
      }
      .modal-form label { display:block; margin-top:1em; font-weight:bold; }
      .modal-form input, .modal-form textarea {
        width: 100%;
        margin-top: 0.3em;
        margin-bottom: 0.7em;
        padding: 0.5em;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1em;
      }
      .modal-form button { margin-top: 1em; }
      .modal-close { float:right; font-size:1.2em; cursor:pointer; color:#785c52; }
    </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | Parakeet Press</title>
  <link rel="stylesheet" href="style.css">
  <style>
        .video-responsive {
          position: relative;
          width: 100%;
          padding-bottom: 56.25%; /* 16:9 aspect ratio */
          height: 0;
          margin: 1.5em 0;
        }
        .video-responsive iframe {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border: 0;
        }
    .product-detail-full {
      width: 100%;
      max-width: 900px;
      margin: 2em auto;
      background: rgba(251, 249, 242, 0.95);
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(120, 92, 82, 0.10);
      border: 1.5px solid #785c52;
      padding: 2.5em 2em;
      display: block;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
      .product-detail-full {
        padding: 1.2em 0.5em;
      }
    }
    .product-detail-full h2 {
      font-size: 2em;
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <header>
    <img src="pp_files/PP_Logo_Original.png" alt="Parakeet Press Logo" style="height:48px;vertical-align:middle;margin-right:12px;border-radius:12px;">
    <a href="/" style="text-decoration:none;color:inherit;"><h1 style="display:inline;vertical-align:middle;">PARAKEET PRESS</h1></a>
    <nav>
      <a href="/">Home</a>
      <a href="services.html">Services</a>
      <a href="store.html">Store</a>
      <a href="chirp.html">Chirp!</a>
    </nav>
  </header>
  <main>
    <section id="product-detail" style="margin-top:2em;">
      <h2>Product Details</h2>
      <div id="product-detail-card"></div>
    </section>
  </main>
  <footer>
    <p id="copyright"></p>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var year = new Date().getFullYear();
        var copyright = document.getElementById('copyright');
        if (copyright) {
          copyright.innerHTML = `&copy; ${year} Parakeet Press. All rights reserved.`;
        }
      });
    </script>
  </footer>
  <script>
    // Robust CSV parser for quoted fields
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current);
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = (i < values.length && values[i] !== undefined) ? values[i].trim() : '');
        return obj;
      });
    }
    function getTitle() {
      const params = new URLSearchParams(window.location.search);
      return params.get('title');
    }
    function renderProduct(p) {
      let videoEmbed = '';
      if (p.videoLink && p.videoLink.startsWith('http')) {
        let vidId = '';
        if (p.videoLink.includes('youtube.com')) {
          const match = p.videoLink.match(/[?&]v=([^&]+)/);
          vidId = match ? match[1] : '';
        } else if (p.videoLink.includes('youtu.be/')) {
          vidId = p.videoLink.split('youtu.be/')[1];
        }
        if (vidId) {
          videoEmbed = `<div class="video-responsive"><iframe src="https://www.youtube.com/embed/${vidId}" allowfullscreen></iframe></div>`;
        }
      }
      // Fallbacks for blank fields
      const title = p.title && p.title.trim() ? p.title : 'Untitled';
      const instrumentation = p.instrumentation && p.instrumentation.trim() ? p.instrumentation : 'N/A';
      const year = p.year && p.year.trim() ? p.year : 'N/A';
      const duration = p.duration && p.duration.trim() ? p.duration : 'N/A';
      let buyBtn = '';
      const btnText = (p.buyMethod && p.buyMethod.trim()) ? p.buyMethod : 'Buy Score';
      if (p.buyLink && p.buyLink.trim() !== '') {
        const link = p.buyLink.trim();
        if (link.includes('@') && !link.startsWith('http')) {
          // Email address: show popup form
          buyBtn = `<button class="buy-btn" type="button" id="open-email-modal">${btnText}</button>`;
        } else {
          // Regular link
          buyBtn = `<a class="buy-btn" href="${link}" target="_blank">${btnText}</a>`;
        }
      } else {
        buyBtn = `<div class="not-available">Sorry! This score is not yet available, please contact Daniel at <a href='mailto:parakeetpress@gmail.com'>parakeetpress@gmail.com</a></div>`;
      }
      let price = 'Contact for price';
      if (p.price && p.price.trim()) {
        // Try to extract a number from the price string
        const priceNum = parseFloat(p.price.replace(/[^\d.]/g, ''));
        if (!isNaN(priceNum)) {
          price = `$${priceNum.toFixed(2)}`;
        } else {
          price = p.price.trim();
        }
      }
      const priceNotes = p.priceNotes && p.priceNotes.trim() ? `<div style='margin:0.2em 0 0.7em 0;font-style:italic;color:#555;'>${p.priceNotes}</div>` : '';
      return `
        <div class="product-detail-full">
          <h2 style="margin-top:0;">${title}</h2>
          <p><strong>Instrumentation:</strong> ${instrumentation}</p>
          <p><strong>Duration:</strong> ${duration} min</p>
          <p><strong>Year:</strong> ${year}</p>
          <div style="margin:1.2em 0 0.2em 0;font-weight:bold;">Price: <span style='font-weight:normal;'>${price}</span></div>
          ${priceNotes}
          <div style="margin:0.5em 0 0.5em 0;font-weight:bold;">Purchase Options:</div>
          ${buyBtn}
          ${videoEmbed}
        </div>
        <div class="modal-bg" id="email-modal">
          <form class="modal-form" id="email-form" onsubmit="return false;">
            <span class="modal-close" id="close-email-modal">&times;</span>
            <h3>Contact to Buy Score</h3>
            <label for="yourName">Your Name</label>
            <input type="text" id="yourName" name="yourName" required>
            <label for="yourEmail">Your Email</label>
            <input type="email" id="yourEmail" name="yourEmail" required>
            <label for="yourSubject">Subject</label>
            <input type="text" id="yourSubject" name="yourSubject" value="Score Purchase Inquiry: ${title}" required>
            <label for="yourMsg">Message</label>
            <textarea id="yourMsg" name="yourMsg" rows="4">Hello,\n\nI am interested in purchasing the score for \"${title}\" (${instrumentation}, ${duration} min, ${year}).\n\nThank you!</textarea>
            <button type="submit" class="buy-btn">Send Email</button>
          </form>
        </div>
      `;
        // Email modal logic
        document.addEventListener('click', function(e) {
          if (e.target && e.target.id === 'open-email-modal') {
            document.getElementById('email-modal').classList.add('active');
          }
          if (e.target && e.target.id === 'close-email-modal') {
            document.getElementById('email-modal').classList.remove('active');
          }
        });
        document.addEventListener('submit', function(e) {
          if (e.target && e.target.id === 'email-form') {
            const name = document.getElementById('yourName').value;
            const email = document.getElementById('yourEmail').value;
            let msg = document.getElementById('yourMsg').value;
            const mailto = document.querySelector('.buy-btn[type="button"]').getAttribute('data-mailto') || '';
            // Compose mailto link
            const to = document.querySelector('.buy-btn[type="button"]').getAttribute('data-to') || '';
            const subject = encodeURIComponent(`Score Purchase Inquiry: ${document.querySelector('.product-detail-full h2').textContent}`);
            // Add name/email to message
            msg = `Name: ${name}\nEmail: ${email}\n\n${msg}`;
            const body = encodeURIComponent(msg);
            // Find the email address from the buyLink
            let emailAddr = '';
            const btn = document.getElementById('open-email-modal');
            if (btn) {
              // Try to extract from the product data
              const products = window._lastProducts || [];
              const rawTitle = getTitle();
              const decodedTitle = rawTitle ? decodeURIComponent(rawTitle).replace(/\+/g, ' ').trim().toLowerCase() : '';
              const p = products.find(prod => (prod.title || '').trim().toLowerCase() === decodedTitle);
              if (p && p.buyLink) emailAddr = p.buyLink.trim();
            }
            if (!emailAddr) emailAddr = 'parakeetpress@gmail.com';
            window.location.href = `mailto:${emailAddr}?subject=${subject}&body=${body}`;
            document.getElementById('email-modal').classList.remove('active');
          }
        });
    }
    const card = document.getElementById('product-detail-card');
    function showError(msg) {

      card.innerHTML = `<div class="not-available">${msg}</div>`;
    }
    fetch('pp_files/pp_store/scoresShop.csv')
      .then(res => {
        if (!res.ok) {
          showError('Error loading product data.');
          throw new Error('Network error');
        }
        return res.text();
      })
      .then(text => {
        let products;
        try {
          products = parseCSV(text);
        } catch (e) {
          showError('Error parsing product data.');
          throw e;
        }
        const rawTitle = getTitle();
        if (!rawTitle) {
          showError('No product specified.');
          return;
        }
        const decodedTitle = decodeURIComponent(rawTitle).replace(/\+/g, ' ').trim().toLowerCase();
        const p = products.find(prod => (prod.title || '').trim().toLowerCase() === decodedTitle);
        if (!p) {
          showError('Product not found.');
          return;
        }
        try {
          card.innerHTML = renderProduct(p);
          // Attach modal event listeners after rendering
          setTimeout(() => {
            const openBtn = document.getElementById('open-email-modal');
            const closeBtn = document.getElementById('close-email-modal');
            const modal = document.getElementById('email-modal');
            const form = document.getElementById('email-form');
            if (openBtn && modal) {
              openBtn.onclick = () => { modal.classList.add('active'); };
            }
            if (closeBtn && modal) {
              closeBtn.onclick = () => { modal.classList.remove('active'); };
            }
            if (form) {
              form.onsubmit = function() {
                const name = document.getElementById('yourName').value;
                const email = document.getElementById('yourEmail').value;
                const subjectRaw = document.getElementById('yourSubject').value;
                let msg = document.getElementById('yourMsg').value;
                // Compose message with name/email at the top
                msg = `Name: ${name}\nEmail: ${email}\n\n${msg}`;
                // Encode subject and body for mailto
                const subject = encodeURIComponent(subjectRaw);
                const body = encodeURIComponent(msg);
                // Find the email address from the buyLink
                let emailAddr = '';
                const products = window._lastProducts || [];
                const rawTitle = getTitle();
                const decodedTitle = rawTitle ? decodeURIComponent(rawTitle).replace(/\+/g, ' ').trim().toLowerCase() : '';
                const p = products.find(prod => (prod.title || '').trim().toLowerCase() === decodedTitle);
                if (p && p.buyLink) emailAddr = p.buyLink.trim();
                if (!emailAddr) emailAddr = 'parakeetpress@gmail.com';
                window.location.href = `mailto:${emailAddr}?subject=${subject}&body=${body}`;
                modal.classList.remove('active');
                return false;
              };
            }
          }, 0);
        } catch (e) {
          showError('Error displaying product details.');
        }
      })
      .catch(e => {
        if (!card.innerHTML) showError('Unexpected error loading product.');
      });
  </script>
</body>
</html>
